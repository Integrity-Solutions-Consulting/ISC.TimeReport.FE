<!-- projection-view.component.html -->
<div class="container">
  <!--
  <div class="projection-header">
    <h4 style="font-family: 'Poppins'; margin-bottom: 20px;">
      Proyección: {{ projectionName }}
    </h4>
  </div>
  -->
  <div *ngIf="!isNewProjection() && projectionName" class="existing-projection-header">
    <h4 class="projection-title">
      <mat-icon>edit</mat-icon>
      Editando: {{ projectionName }}
    </h4>
  </div>

  <div *ngIf="isNewProjection()" class="new-projection-header">
    <h4 class="new-projection-title">
      <mat-icon>add_circle</mat-icon>
      Nueva Proyección
    </h4>
    <p>Complete la información para crear una nueva proyección de horas.</p>
  </div>

  <!-- Estado de carga del catálogo -->
  <div *ngIf="isLoadingPositions" class="loading-state">
    <mat-spinner></mat-spinner>
    <p>Cargando catálogo de posiciones...</p>
  </div>

  <div *ngIf="!isLoadingPositions">
    <div class="configuration-section">
      <h6 style="font-family: 'Poppins';">Configuración de Períodos</h6>

      <div class="config-controls">
        <mat-form-field appearance="outline">
          <mat-select placeholder="Tipo de Período" name="period" [(ngModel)]="selectedPeriod">
            @for (period of periods; track period) {
              <mat-option [value]="period.value">{{period.viewValue}}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <input matInput
                placeholder="Cantidad de Períodos"
                type="number"
                [(ngModel)]="periodQuantity"
                min="1"
                max="24"
                required>
        </mat-form-field>

        <button mat-flat-button
                color="primary"
                (click)="applyConfiguration()"
                [disabled]="!periodQuantity || periodQuantity < 1">
          <mat-icon>settings</mat-icon>
          Aplicar Configuración
        </button>
      </div>

      <mat-divider></mat-divider>
    </div>

    <div class="table-section" *ngIf="showTable">
      <div class="table-header">
        <h6 style="font-family: 'Poppins';">Distribución de Horas por Proyecto</h6>
        <div class="header-actions">
          <button mat-icon-button
                  color="primary"
                  (click)="addRow()"
                  matTooltip="Agregar fila">
            <mat-icon>add</mat-icon>
          </button>
          <button mat-icon-button
                  color="accent"
                  class="info-button"
                  matTooltip="Agregar Fila">
            <mat-icon>help_outline</mat-icon>
          </button>
        </div>
      </div>

      <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">

          <!-- Tipo de Recurso Column - Ahora con catálogo -->
          <ng-container matColumnDef="tipoRecurso">
            <th mat-header-cell *matHeaderCellDef>Tipo de Recurso</th>
            <td mat-cell *matCellDef="let element; let i = index">
              <mat-form-field appearance="outline" class="full-width">
                <mat-select [(ngModel)]="element.tipoRecurso" (selectionChange)="onResourceTypeChange(i)">
                  <mat-option value="">Seleccionar posición</mat-option>
                  @for (position of positionsCatalog; track position.id) {
                    <mat-option [value]="position.positionName">
                      {{ position.positionName }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Resto de las columnas se mantienen igual -->
          <ng-container matColumnDef="nombreRecurso">
            <th mat-header-cell *matHeaderCellDef>Nombre Recurso</th>
            <td mat-cell *matCellDef="let element; let i = index">
              <mat-form-field appearance="outline" class="full-width">
                <input matInput [(ngModel)]="element.nombreRecurso" (input)="calculateTotals()">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="costoPorHora">
            <th mat-header-cell *matHeaderCellDef>Costo por Hora</th>
            <td mat-cell *matCellDef="let element; let i = index">
              <mat-form-field appearance="outline" class="full-width">
                <input matInput type="number" [(ngModel)]="element.costoPorHora" (input)="calculateTotals()" min="0">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="cantidadRecursos">
            <th mat-header-cell *matHeaderCellDef>Cant. Recursos</th>
            <td mat-cell *matCellDef="let element; let i = index">
              <mat-form-field appearance="outline" class="full-width">
                <input matInput type="number" [(ngModel)]="element.cantidadRecursos" (input)="calculateTotals()" min="1" value="1">
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Dynamic Period Columns -->
          <ng-container *ngFor="let period of dynamicColumns; let i = index" [matColumnDef]="period">
            <th mat-header-cell *matHeaderCellDef class="compact-header">{{ getColumnHeader(i) }}</th>
            <td mat-cell *matCellDef="let element" class="compact-cell">
              <mat-form-field appearance="outline" class="compact-field">
                <input matInput type="number"
                      [(ngModel)]="element[period]"
                      (input)="calculateTotals()"
                      min="0"
                      step="0.1"
                      class="compact-input">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="tiempoTotal">
            <th mat-header-cell *matHeaderCellDef>Tiempo Total</th>
            <td mat-cell *matCellDef="let element">{{ element.tiempoTotal | number:'1.1-1' }}</td>
          </ng-container>

          <ng-container matColumnDef="costoRecurso">
            <th mat-header-cell *matHeaderCellDef>Costo Recurso</th>
            <td mat-cell *matCellDef="let element">{{ element.costoRecurso | currency }}</td>
          </ng-container>

          <ng-container matColumnDef="porcentajeParticipacion">
            <th mat-header-cell *matHeaderCellDef>% Participación</th>
            <td mat-cell *matCellDef="let element">{{ element.porcentajeParticipacion | number:'1.1-1' }}%</td>
          </ng-container>

              <ng-container matColumnDef="estado">
                <th mat-header-cell *matHeaderCellDef>Estado</th>
                <td mat-cell *matCellDef="let element; let i = index" class="status-cell">
                  <div class="status-container">
                    <!-- Para proyecciones existentes -->
                    <div *ngIf="!isNewProjection() && element.isExisting"
                        class="status-indicator"
                        [class.active]="element.isActive"
                        [class.inactive]="!element.isActive">
                      <mat-icon class="status-icon">
                        {{ element.isActive ? 'check_circle' : 'cancel' }}
                      </mat-icon>
                      {{ element.isActive ? 'Activo' : 'Inactivo' }}
                    </div>

                    <!-- Para nuevas proyecciones o filas nuevas -->
                    <div *ngIf="isNewProjection() || !element.isExisting"
                        class="status-indicator new">
                      <mat-icon class="status-icon">add_circle</mat-icon>
                      Nuevo
                    </div>
                  </div>
                </td>
              </ng-container>

          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let element; let i = index">
              <div class="action-buttons">

                <!-- Botón para activar (solo visible si está inactivo) -->
                <button *ngIf="!isNewProjection() && element.isExisting && !element.isActive"
                        mat-icon-button
                        color="primary"
                        (click)="activateResource(element, i)"
                        matTooltip="Activar recurso">
                  <mat-icon>toggle_on</mat-icon>
                </button>

                <!-- Botón para inactivar (solo visible si está activo) -->
                <button *ngIf="!isNewProjection() && element.isExisting && element.isActive"
                        mat-icon-button
                        color="warn"
                        (click)="inactivateResource(element, i)"
                        matTooltip="Inactivar recurso">
                  <mat-icon>toggle_off</mat-icon>
                </button>

                <!-- Botón para eliminar en nuevas proyecciones o filas nuevas -->
                <button *ngIf="isNewProjection() || !element.isExisting"
                        mat-icon-button
                        color="warn"
                        (click)="removeRow(i)"
                        [disabled]="isRemoving"
                        matTooltip="Eliminar fila">
                  <mat-icon>delete</mat-icon>
                </button>

              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row
              *matRowDef="let row; columns: displayedColumns;"
              [class.row-inactive]="!row.isActive && !isNewProjection() && row.isExisting">
          </tr>
        </table>
      </div>

      <div class="table-footer">
        <div class="total-row">
          <strong>Total</strong>
          <span>{{ totalTiempo | number:'1.1-1' }}</span>
          <span>{{ totalCosto | currency }}</span>
          <span>100.0%</span>
        </div>

        <div class="footer-buttons">
          <button mat-flat-button
                  color="primary"
                  (click)="saveAllProjections()"
                  [disabled]="!canSaveProjection()">
            <mat-icon>{{ isNewProjection() ? 'add_circle' : 'save' }}</mat-icon>
            {{ isNewProjection() ? 'Crear Proyección' : 'Actualizar Proyección' }}
          </button>

          <button *ngIf="!isNewProjection()"
                  mat-flat-button
                  color="accent"
                  (click)="exportToExcel()"
                  [disabled]="!canExportToExcel()"
                  matTooltip="Exportar a Excel">
            <mat-icon>download</mat-icon>
            Exportar Excel
          </button>

          <button *ngIf="!isNewProjection()"
                mat-stroked-button
                color="warn"
                (click)="cancelEdit()">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        </div>
      </div>
    </div>
  </div>
</div>
