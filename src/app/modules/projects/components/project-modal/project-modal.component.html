<app-loading *ngIf="isLoading"></app-loading>
<h4 mat-dialog-title style="margin: 10px; font-family: 'Poppins'">
  {{ isEditMode ? 'Editar Proyecto' : 'Crear Nuevo Proyecto' }}
</h4>
<mat-dialog-content>
  <form [formGroup]="projectForm" class="full-width" style="margin-top: 5px;">

    <div class="form-row">
      <!-- Código del Proyecto -->
      <div class="field-with-help">
        <mat-form-field appearance="outline" class="form-field-half">
          <input matInput formControlName="code" placeholder="Código del Proyecto">
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Ingresa un código único para identificar el proyecto (ej. PROY-001, WEB-2023)'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Nombre del Proyecto -->
      <div class="field-with-help">
        <mat-form-field appearance="outline" class="form-field-half">
          <input matInput formControlName="name" placeholder="Nombre del Proyecto">
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Ingresa el nombre completo del proyecto (máximo 150 caracteres)'" matTooltipPosition="right">
          ?
        </div>
      </div>
    </div>

    <div class="form-row">
      <!-- Descripción -->
      <div class="field-with-help">
        <mat-form-field appearance="outline" class="full-width">
          <input matInput formControlName="description" placeholder="Descripción">
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Describe brevemente el objetivo y alcance del proyecto'" matTooltipPosition="right">
          ?
        </div>
      </div>
    </div>

    <div class="form-row">
      <!-- Cliente -->
      <div class="field-with-help">
        <mat-form-field appearance="outline" class="form-field-half">
          <mat-select formControlName="clientId" placeholder="Cliente">
            <!-- Campo de búsqueda para clientes -->
            <mat-option>
              <ngx-mat-select-search
                [formControl]="clientFilterCtrl"
                placeholderLabel="Buscar cliente..."
                noEntriesFoundLabel="No se encontraron clientes">
              </ngx-mat-select-search>
            </mat-option>

            @if (isLoadingClients) {
              <mat-option disabled>Cargando clientes...</mat-option>
            } @else {
              @for (client of filteredClients | async; track client.id) {
                <mat-option [value]="client.id">{{client.tradeName}}</mat-option>
              }
            }
          </mat-select>
          @if (isLoadingClients) {
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          }
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Selecciona el cliente para el cual se realiza el proyecto. Puedes buscar por nombre comercial.'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Estado del Proyecto -->
      <div class="field-with-help">
        <mat-form-field appearance="outline" class="form-field-half">
          <mat-select formControlName="projectStatusId" placeholder="Estado del Proyecto">
            @if (isLoadingStatuses) {
              <mat-option disabled>Cargando estados...</mat-option>
            } @else {
              @for (status of projectStatuses; track status.id) {
                <mat-option [value]="status.id">{{status.statusName}}</mat-option>
              }
            }
          </mat-select>
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Selecciona el estado actual del proyecto (Planificación, En Progreso, Completado, etc.)'" matTooltipPosition="right">
          ?
        </div>
      </div>
    </div>

    <div class="form-row">
      <!-- Tipo de proyecto -->
      <div class="field-with-help">
        <mat-form-field class="form-field-half" appearance="outline">
          <mat-label>Tipo de proyecto</mat-label>
          <mat-select formControlName="projectTypeId" required>
            <mat-option *ngFor="let type of formattedProjectTypes" [value]="type.id">
              {{ type.displayName }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Selecciona el tipo de proyecto (Facturable, No Facturable, Interno, etc.)'" matTooltipPosition="right">
          ?
        </div>
      </div>
    </div>

    <div class="form-row date-fields-container">
      <!-- Fecha de Inicio -->
      <div class="field-with-help date-field">
        <mat-form-field appearance="outline">
          <input matInput [matDatepicker]="picker1" formControlName="startDate" placeholder="Fecha de Inicio">
          <mat-hint>DD/MM/YYYY</mat-hint>
          <mat-datepicker-toggle matIconSuffix [for]="picker1"></mat-datepicker-toggle>
          <mat-datepicker #picker1></mat-datepicker>
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Selecciona la fecha planificada de inicio del proyecto'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Fecha de Terminación -->
      <div class="field-with-help date-field">
        <mat-form-field appearance="outline">
          <input matInput [matDatepicker]="picker2" formControlName="endDate" [min]="projectForm.get('startDate')?.value" placeholder="Fecha de Terminación">
          <mat-hint>DD/MM/YYYY</mat-hint>
          <mat-datepicker-toggle matIconSuffix [for]="picker2"></mat-datepicker-toggle>
          <mat-datepicker #picker2></mat-datepicker>
          <mat-error *ngIf="projectForm.get('endDate')?.hasError('required')">
            La fecha de fin es requerida
          </mat-error>
          <mat-error *ngIf="projectForm.hasError('dateRange')">
            La fecha de fin no puede ser anterior a la fecha de inicio
          </mat-error>
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Selecciona la fecha planificada de finalización del proyecto. Debe ser posterior a la fecha de inicio.'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Fecha Terminación Real (solo visible cuando es necesario) -->
      <div class="field-with-help date-field" *ngIf="showClientWaitingFields">
        <mat-form-field appearance="outline">
          <input matInput [matDatepicker]="pickerEstimatedEnd" formControlName="estimatedEndDate" placeholder="Fecha Terminación Real">
          <mat-hint>DD/MM/YYYY</mat-hint>
          <mat-datepicker-toggle matIconSuffix [for]="pickerEstimatedEnd"></mat-datepicker-toggle>
          <mat-datepicker #pickerEstimatedEnd></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <div *ngIf="showClientWaitingFields" class="client-waiting-info-section">
      <!-- Campos de fecha inicio y fin de espera -->
      <div class="form-row">
        <div class="field-with-help">
          <mat-form-field class="form-field-half" appearance="outline">
            <input matInput [matDatepicker]="pickerWaitStart" formControlName="waitStartDate" placeholder="Fecha Inicio Espera">
            <mat-hint>DD/MM/YYYY</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="pickerWaitStart"></mat-datepicker-toggle>
            <mat-datepicker #pickerWaitStart></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="field-with-help">
          <mat-form-field class="form-field-half" appearance="outline">
            <input matInput [matDatepicker]="pickerWaitEnd" formControlName="waitEndDate" [min]="projectForm.get('waitStartDate')?.value" placeholder="Fecha Fin Espera">
            <mat-hint>DD/MM/YYYY</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="pickerWaitEnd"></mat-datepicker-toggle>
            <mat-datepicker #pickerWaitEnd></mat-datepicker>
          </mat-form-field>
        </div>
      </div>

      <!-- Campo de observaciones -->
      <div class="form-row">
        <div class="field-with-help">
          <mat-form-field appearance="outline" class="full-width">
            <textarea matInput formControlName="observations" placeholder="Observaciones sobre la espera..." rows="3"></textarea>
            <mat-hint>{{projectForm.get('observations')?.value?.length || 0}}/50 caracteres</mat-hint>
          </mat-form-field>
        </div>
      </div>
    </div>

    <div class="form-row">
      <!-- Presupuesto -->
      <div class="field-with-help">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label style="font-family: 'Poppins'; ">Presupuesto</mat-label>
          <input matInput formControlName="budget" type="number" min="0" placeholder="Presupuesto">
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Ingresa el presupuesto total asignado al proyecto (en la moneda correspondiente)'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Número de Horas -->
      <div class="field-with-help">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label style="font-family: 'Poppins'; ">Número de Horas</mat-label>
          <input matInput formControlName="hours" type="number" min="0" placeholder="Número de Horas">
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Ingresa el número total de horas estimadas para completar el proyecto'" matTooltipPosition="right">
          ?
        </div>
      </div>
    </div>

  </form>
</mat-dialog-content>
<mat-dialog-actions>
  <button mat-raised-button (click)="onCancel()" >Cancelar</button>
  <button mat-raised-button
          style="background-color: var(--itg-primary); color: var(--itg-bg)"
          (click)="onSubmit()"
          [disabled]="projectForm.invalid || projectForm.pending || isSubmitting">
    {{isSubmitting ? 'Guardando...' : 'Guardar'}}
  </button>
</mat-dialog-actions>
