<!-- assignment-dialog.component.html -->
<h2 mat-dialog-title>
  Asignación de Recursos - {{data.projectName}}
  <button mat-icon-button class="close-button" (click)="cancel()">
    <mat-icon>close</mat-icon>
  </button>
</h2>
<mat-dialog-content>
  <form [formGroup]="assignmentForm">
    <div class="resource-type-section">
      <div class="type-selector">
        <span>Tipo de Recurso</span>
        <mat-form-field appearance="outline">
          <mat-select formControlName="resourceType"
                      placeholder="Seleccione Tipo">
            @for (type of resourceTypes; track type) {
              <mat-option [value]="type.id">{{type.name}}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <div class="resource-details">
      <div class="field-group">
        <span>Recurso</span>
        <mat-form-field appearance="outline">
          <mat-select formControlName="resource">
            <!-- Campo de búsqueda para recursos -->
            <mat-option>
              <ngx-mat-select-search
                [formControl]="resourceFilterCtrl"
                placeholderLabel="Buscar recurso..."
                noEntriesFoundLabel="No se encontraron recursos">
              </ngx-mat-select-search>
            </mat-option>

            @if (selectedResourceType === 1) {
              @for (emp of filteredEmployees | async; track emp.id) {
                <mat-option [value]="emp.id">
                  {{emp.person.firstName}} {{emp.person.lastName}}
                  @if (emp.positionName || emp.position?.positionName) {
                    - {{emp.positionName || emp.position?.positionName}}
                  }
                </mat-option>
              }
            } @else {
               @for (prov of filteredProviders | async; track prov.id) {
                <mat-option [value]="prov.id">
                  {{prov.businessName}} ({{prov.supplierType.name}})
                </mat-option>
              }
            }
          </mat-select>
        </mat-form-field>
      </div>

      <div class="field-group">
        <span>Perfil</span>
        <mat-form-field appearance="outline">
          <mat-select formControlName="profile">
            <!-- Campo de búsqueda para perfiles -->
            <mat-option>
              <ngx-mat-select-search
                [formControl]="profileFilterCtrl"
                placeholderLabel="Buscar perfil..."
                noEntriesFoundLabel="No se encontraron perfiles">
              </ngx-mat-select-search>
            </mat-option>

            @if (selectedResourceType === 1) {
              @for (position of filteredPositions | async; track position.id) {
                <mat-option [value]="position.positionName">{{position.positionName}}</mat-option>
              }
            } @else {
              <mat-option [value]="'Proveedor'">Proveedor</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <div class="field-group">
        <span>Costo/Hora</span>
        <mat-form-field appearance="outline">
          <input matInput type="number" formControlName="costPerHour" placeholder="Ej. 10">
        </mat-form-field>
      </div>

      <div class="field-group">
        <span>Total Horas</span>
        <mat-form-field appearance="outline">
          <input matInput type="number" formControlName="totalHours" placeholder="Ej. 40">
        </mat-form-field>
      </div>

      <button mat-raised-button
              style="background-color: var(--itg-primary-bg); color: var(--itg-primary)"
              (click)="addResource()"
              [disabled]="!assignmentForm.valid">
        Agregar
        <mat-icon aria-hidden="false" aria-label="Example home icon" fontIcon="add"></mat-icon>
      </button>
    </div>
  </form>

  <div class="selected-resources" *ngIf="existingAssignments.length > 0 || selectedResources.length > 0">
    <!-- Tabla de asignaciones existentes -->
    <div *ngIf="existingAssignments.length > 0">
      <h4>Recursos asignados previamente ({{existingAssignments.length}})</h4>
      <div class="table-container">
        <table mat-table [dataSource]="existingAssignments">
          <!-- Columna Tipo -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef> Tipo </th>
            <td mat-cell *matCellDef="let element">
              {{element.employeeID ? 'Empleado' : 'Proveedor'}}
            </td>
          </ng-container>

          <!-- Columna Nombre -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef> Nombre </th>
            <td mat-cell *matCellDef="let element">
              {{getResourceName(element)}}
            </td>
          </ng-container>

          <!-- Columna Perfil -->
          <ng-container matColumnDef="profile">
            <th mat-header-cell *matHeaderCellDef> Perfil </th>
            <td mat-cell *matCellDef="let element">
              {{element.assignedRole}}
            </td>
          </ng-container>

          <!-- Columna Costo/Hora -->
          <ng-container matColumnDef="cost">
            <th mat-header-cell *matHeaderCellDef> Costo/Hora </th>
            <td mat-cell *matCellDef="let element">
              {{element.costPerHour | currency:'USD':'symbol':'1.2-2'}}
            </td>
          </ng-container>

          <!-- Columna Horas -->
          <ng-container matColumnDef="hours">
            <th mat-header-cell *matHeaderCellDef> Horas </th>
            <td mat-cell *matCellDef="let element">
              {{element.allocatedHours}}
            </td>
          </ng-container>

          <!-- Columna Acciones -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Acciones </th>
            <td mat-cell *matCellDef="let element; let i = index">
              <button mat-icon-button (click)="removeResource(i, true)" color="warn">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </div>

    <!-- Tabla de recursos a asignar -->
    <div *ngIf="selectedResources.length > 0">
      <h4>Recursos a asignar ({{selectedResources.length}})</h4>
      <div class="table-container">
        <table mat-table [dataSource]="selectedResources">
          <!-- Columna Tipo -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef> Tipo </th>
            <td mat-cell *matCellDef="let element">
              {{element.employeeId ? 'Empleado' : 'Proveedor'}}
            </td>
          </ng-container>

          <!-- Columna Nombre -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef> Nombre </th>
            <td mat-cell *matCellDef="let element">
              {{getResourceName(element)}}
            </td>
          </ng-container>

          <!-- Columna Perfil -->
          <ng-container matColumnDef="profile">
            <th mat-header-cell *matHeaderCellDef> Perfil </th>
            <td mat-cell *matCellDef="let element">
              {{element.assignedRole}}
            </td>
          </ng-container>

          <!-- Columna Costo/Hora -->
          <ng-container matColumnDef="cost">
            <th mat-header-cell *matHeaderCellDef> Costo/Hora </th>
            <td mat-cell *matCellDef="let element">
              {{element.costPerHour | currency:'USD':'symbol':'1.2-2'}}
            </td>
          </ng-container>

          <!-- Columna Horas -->
          <ng-container matColumnDef="hours">
            <th mat-header-cell *matHeaderCellDef> Horas </th>
            <td mat-cell *matCellDef="let element">
              {{element.allocatedHours}}
            </td>
          </ng-container>

          <!-- Columna Acciones -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Acciones </th>
            <td mat-cell *matCellDef="let element; let i = index">
              <button mat-icon-button (click)="removeResource(i)" color="warn">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </div>
  </div>
</mat-dialog-content>
<mat-dialog-actions>
  <button style="color: var(--itg-primary)" mat-raised-button (click)="cancel()">Cancelar</button>
  <button style="background-color: var(--itg-primary); color: var(--itg-bg)"
          mat-raised-button
          (click)="assignResources()"
          >
    Asignar
  </button>
</mat-dialog-actions>
