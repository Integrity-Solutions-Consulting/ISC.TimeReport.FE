<h2 mat-dialog-title>{{ data.isEdit ? 'Editar actividad' : 'Agregar actividad' }}</h2>

<mat-dialog-content>
  <div class="form-container">

    <!-- Tipo de Actividad -->
    <div class="field-with-help">
      <mat-form-field appearance="outline" class="full-width">
        <mat-select [(ngModel)]="event.activityTypeID" required placeholder="Tipo de Actividad" name="activityType">
          @for (type of activityTypes; track type.id) {
            <mat-option [value]="type.id">{{type.name}}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <div class="help-icon" [matTooltip]="'Selecciona el tipo de actividad que vas a registrar (ej. Desarrollo, Testing, Reunión, etc.)'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Proyecto -->
    <div class="field-with-help">
      <mat-form-field appearance="outline" class="full-width">
        <mat-select [(ngModel)]="event.projectID"
                    (ngModelChange)="onProjectChange($event)"
                    required
                    placeholder="Proyecto"
                    name="projectID">
            @if (projects.length > 0) {
                @for (project of projects; track project.id) {
                    <mat-option [value]="project.id">{{project.name}}</mat-option>
                }
            } @else {
                <mat-option disabled>No tienes proyectos asignados</mat-option>
            }
        </mat-select>
      </mat-form-field>
      <div class="help-icon" [matTooltip]="'Selecciona el proyecto al que pertenece esta actividad. Si no ves proyectos, contacta a tu administrador.'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Código de Requerimiento -->
    <div class="field-with-help">
      <mat-form-field appearance="outline" class="full-width">
        <input matInput
              [(ngModel)]="event.requirementCode"
              placeholder="Código de Requerimiento"
              [required]="!event.projectId"
              name="requirementCode">
      </mat-form-field>
      <div class="help-icon" [matTooltip]="'Ingresa el código del requerimiento o ticket asociado a esta actividad (ej. JIRA-123, PROY-456)'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Descripción -->
    <div class="field-with-help">
      <mat-form-field appearance="outline" class="fixed-textarea full-width">
        <textarea matInput
          [(ngModel)]="event.activityDescription"
          rows="5"
          placeholder="Descripción"
          required
          name="description"
          maxlength="200"
          (input)="trimDescription()"
          #descInput="ngModel"
          class="fixed-textarea">
        </textarea>
        <mat-hint align="end">{{event.activityDescription?.length || 0}}/200</mat-hint>
        <mat-error *ngIf="descInput.errors?.['maxlength']">
          La descripción no puede exceder los 200 caracteres
        </mat-error>
      </mat-form-field>
      <div class="help-icon" [matTooltip]="'Describe brevemente la actividad realizada. Máximo 200 caracteres.'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Duración -->
    <div class="field-with-help">
      <div class="duration-container">
        <span>Duración:</span>
        <mat-slide-toggle [(ngModel)]="isFullDay" (change)="onDurationChange()" color="primary" name="durationToggle">
          {{isFullDay ? 'Día Completo' : 'Horas'}}
        </mat-slide-toggle>
      </div>
      <div class="help-icon" [matTooltip]="'Selecciona si la actividad ocupa todo el día o solo algunas horas. Día completo registrará 8 horas automáticamente.'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Fecha y Horas -->
    <div class="field-with-help">
      <div class="row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Fecha Actividad</mat-label>
          <input matInput
                [matDatepicker]="activityDatePicker"
                [(ngModel)]="event.activityDate"
                required
                name="activityDate"
                placeholder="dd/mm/aaaa">
          <mat-datepicker-toggle matSuffix [for]="activityDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #activityDatePicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="!isFullDay" class="half-width">
          <mat-label>Número de Horas</mat-label>
          <input matInput type="number" [(ngModel)]="event.hours" name="hours" min="1" max="8" [required]="!isFullDay" (ngModelChange)="validateHours()">
          <mat-error *ngIf="!isFullDay">
            Horas inválidas (debe ser entre 1 y 8).
          </mat-error>
        </mat-form-field>
      </div>
      <div class="help-icon" [matTooltip]="'Selecciona la fecha de la actividad y, si no es día completo, ingresa el número de horas trabajadas (máximo 8 por día).'" matTooltipPosition="right">
        ?
      </div>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-raised-button (click)="onCancel()">Cancelar</button>
  <button mat-raised-button style="background-color: var(--itg-primary); color: var(--itg-bg)" [mat-dialog-close]="preparePayload()" [disabled]="!isFormValid()">
    {{ data.isEdit ? 'Editar' : 'Agregar' }}
  </button>
</mat-dialog-actions>
