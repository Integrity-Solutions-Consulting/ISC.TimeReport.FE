<h2 mat-dialog-title>{{ data.isEdit ? 'Editar actividad' : 'Agregar actividad' }}</h2>

<mat-dialog-content>
  <div class="form-container">

    <!-- Tipo de Actividad -->
    <div class="field-with-help">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Tipo de Actividad</mat-label>
        <mat-select [(ngModel)]="event.activityTypeID" required placeholder="Tipo de Actividad" name="activityType">
          @for (type of activityTypes; track type.id) {
            <mat-option [value]="type.id">{{type.name}}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <div class="help-icon" [matTooltip]="'Selecciona el tipo de actividad que vas a registrar (ej. Desarrollo, Testing, Reunión, etc.)'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Proyecto -->
    <div class="field-with-help">
      <mat-form-field appearance="outline" class="full-width">
        <mat-select [(ngModel)]="event.projectID"
                    (ngModelChange)="onProjectChange($event)"
                    required
                    placeholder="Proyecto"
                    name="projectID">
            @if (projects.length > 0) {
                @for (project of projects; track project.id) {
                    <mat-option [value]="project.id">{{project.name}}</mat-option>
                }
            } @else {
                <mat-option disabled>No tienes proyectos asignados</mat-option>
            }
        </mat-select>
      </mat-form-field>
      <div class="help-icon" [matTooltip]="'Selecciona el proyecto al que pertenece esta actividad. Si no ves proyectos, contacta a tu administrador.'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Código de Requerimiento -->
    <div class="field-with-help">
      <mat-form-field appearance="outline" class="full-width">
        <input matInput
              [(ngModel)]="event.requirementCode"
              placeholder="Código de Requerimiento"
              [required]="!event.projectId"
              #descInput="ngModel"
              maxlength="50"
              name="requirementCode">
        <mat-hint align="end">{{event.requirementCode?.length || 0}}/50</mat-hint>
        <mat-error *ngIf="descInput.errors?.['maxlength']">
          La descripción no puede exceder los 50 caracteres
        </mat-error>
      </mat-form-field>
      <div class="help-icon" [matTooltip]="'Ingresa el código del requerimiento o ticket asociado a esta actividad (ej. JIRA-123, PROY-456)'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Descripción -->
    <div class="field-with-help">
      <mat-form-field appearance="outline" class="fixed-textarea full-width">
        <textarea matInput
          [(ngModel)]="event.activityDescription"
          rows="5"
          placeholder="Descripción"
          required
          name="description"
          maxlength="200"
          (input)="trimDescription()"
          #descInput="ngModel"
          class="fixed-textarea">
        </textarea>
        <mat-hint align="end">{{event.activityDescription?.length || 0}}/200</mat-hint>
        <mat-error *ngIf="descInput.errors?.['maxlength']">
          La descripción no puede exceder los 200 caracteres
        </mat-error>
      </mat-form-field>
      <div class="help-icon" [matTooltip]="'Describe brevemente la actividad realizada. Máximo 200 caracteres.'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Campos para Actividad NO Recurrente -->
    <div *ngIf="!isRecurring">
      <!-- Fecha y Horas para actividad única -->
      <div class="field-with-help">
        <div class="row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Fecha Actividad</mat-label>
            <input matInput
                  [matDatepicker]="activityDatePicker"
                  [(ngModel)]="event.activityDate"
                  required
                  name="activityDate"
                  placeholder="dd/mm/aaaa">
            <mat-datepicker-toggle matSuffix [for]="activityDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #activityDatePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Número de Horas</mat-label>
            <input matInput
                  type="text"
                  [(ngModel)]="event.hours"
                  name="hours"
                  required
                  (input)="validateHours()"
                  (keypress)="onHoursKeyPress($event)"
                  placeholder="0.5-8">
            <mat-error *ngIf="!event.hours || event.hours < 0.5 || event.hours > 8">
              Horas inválidas (debe ser entre 0.5 y 8).
            </mat-error>
          </mat-form-field>
        </div>
        <div class="help-icon" [matTooltip]="'Selecciona la fecha de la actividad e ingresa el número de horas trabajadas (mínimo 0.5, máximo 8 por día).'" matTooltipPosition="right">
          ?
        </div>
      </div>
    </div>

    <!-- Checkbox para Actividad Recurrente (solo visible cuando no es edición) -->
    <div class="field-with-help" *ngIf="!data.isEdit">
      <mat-checkbox [(ngModel)]="isRecurring" (change)="onRecurringChange()" name="isRecurring">
        Actividad Recurrente
      </mat-checkbox>
      <div class="help-icon" [matTooltip]="'Marca esta opción si deseas crear la misma actividad en múltiples días consecutivos'" matTooltipPosition="right">
        ?
      </div>
    </div>

    <!-- Sección de Recurrencia (solo visible cuando isRecurring es true) -->
    <div *ngIf="isRecurring" class="recurrence-section">
      <div class="field-with-help">
        <div class="row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Fecha Inicio</mat-label>
            <input matInput
                  [matDatepicker]="startDatePicker"
                  [(ngModel)]="recurrenceStartDate"
                  required
                  name="recurrenceStartDate"
                  placeholder="dd/mm/aaaa"
                  (dateChange)="onRecurrenceDatesChange()">
            <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #startDatePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Fecha Fin</mat-label>
            <input matInput
                  [matDatepicker]="endDatePicker"
                  [(ngModel)]="recurrenceEndDate"
                  required
                  name="recurrenceEndDate"
                  placeholder="dd/mm/aaaa"
                  (dateChange)="onRecurrenceDatesChange()">
            <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #endDatePicker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="help-icon" [matTooltip]="'Selecciona el rango de fechas para la actividad recurrente. Se crearán actividades para todos los días en este rango.'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Campo de Horas para actividades recurrentes -->
      <div class="field-with-help">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Horas por día</mat-label>
          <input matInput
                type="text"
                [(ngModel)]="event.hours"
                name="recurrenceHours"
                required
                (input)="validateHours()"
                (keypress)="onHoursKeyPress($event)"
                placeholder="0.5-8">
          <mat-error *ngIf="!event.hours || event.hours < 0.5 || event.hours > 8">
            Horas inválidas (debe ser entre 0.5 y 8).
          </mat-error>
        </mat-form-field>
        <div class="help-icon" [matTooltip]="'Ingresa el número de horas trabajadas por cada día (mínimo 0.5, máximo 8 por día).'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Checkbox para incluir fines de semana -->
      <div class="field-with-help">
        <mat-checkbox [(ngModel)]="includeWeekends" (change)="onRecurrenceDatesChange()">
          Incluir fines de semana
        </mat-checkbox>
        <div class="help-icon" [matTooltip]="'Marca esta opción si deseas incluir sábados y domingos en las actividades recurrentes'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Checkbox para incluir feriados -->
      <div class="field-with-help">
        <mat-checkbox [(ngModel)]="includeHolidays" (change)="onRecurrenceDatesChange()">
          Incluir días feriados
        </mat-checkbox>
        <div class="help-icon" [matTooltip]="'Marca esta opción si deseas incluir días feriados en las actividades recurrentes'" matTooltipPosition="right">
          ?
        </div>
      </div>

      <!-- Información de resumen -->
      <div *ngIf="recurrenceDaysCount > 0" class="recurrence-summary">
        <p>Se crearán {{recurrenceDaysCount}} actividades entre
          {{recurrenceStartDate | date:'dd/MM/yyyy'}} y
          {{recurrenceEndDate | date:'dd/MM/yyyy'}}</p>
      </div>
    </div>

  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  @if (data.isEdit) {
    <button mat-raised-button style="background-color: var(--status-bug-reported); color: var(--status-bug-reported-bg)" (click)="onDelete()">Eliminar</button>
  }
  <button mat-raised-button style="background-color: var(--itg-primary); color: var(--itg-bg)" [mat-dialog-close]="preparePayload()" [disabled]="!isFormValid()">
    {{ data.isEdit ? 'Guardar' : 'Agregar' }}
  </button>
  <button mat-raised-button (click)="onCancel()">Cancelar</button>
</mat-dialog-actions>
