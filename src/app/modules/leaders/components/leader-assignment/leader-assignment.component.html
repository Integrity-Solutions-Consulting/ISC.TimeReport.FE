<!-- leader-assignment.component.html -->
<h2 mat-dialog-title class="dialog-title">
  <mat-icon class="title-icon">assignment_ind</mat-icon>
  Asignaciones de Proyectos - {{leader?.person?.firstName}} {{leader?.person?.lastName}}
</h2>

<mat-dialog-content>
  <div class="dialog-content">
    <!-- Información del líder -->
    <div class="leader-info" *ngIf="leader">
      <div class="info-row">
        <div class="info-item">
          <mat-icon class="info-icon">badge</mat-icon>
          <strong>Identificación:</strong> {{leader.person.identificationNumber}}
        </div>
        <div class="info-item">
          <mat-icon class="info-icon">email</mat-icon>
          <strong>Email:</strong> {{leader.person.email}}
        </div>
      </div>
      <div class="info-row">
        <div class="info-item">
          <mat-icon class="info-icon">phone</mat-icon>
          <strong>Teléfono:</strong> {{leader.person.phone || 'N/A'}}
        </div>
        <div class="info-item">
          <mat-icon class="info-icon">circle</mat-icon>
          <strong>Estado:</strong>
          <span [class.active]="leader.status" [class.inactive]="!leader.status">
            {{leader.status ? 'Activo' : 'Inactivo'}}
          </span>
        </div>
      </div>
    </div>

    <div class="loading-spinner" *ngIf="loading">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Cargando proyectos...</p>
    </div>

    <!-- Formulario para agregar asignaciones -->
    <div *ngIf="!loading" class="assignment-form-section">
      <h3 class="section-title">
        <mat-icon>add_circle</mat-icon>
        Agregar Nueva Asignación
      </h3>

      <form [formGroup]="assignmentForm" class="assignment-form">
        <div class="form-row">
          <mat-form-field appearance="outline" class="project-select">
            <mat-label>Seleccionar Proyecto</mat-label>
            <mat-select formControlName="selectedProject" required>
              <mat-option *ngFor="let project of getAvailableProjects()" [value]="project.id">
                {{project.code}} - {{project.name}}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>folder</mat-icon>
            <mat-error *ngIf="assignmentForm.get('selectedProject')?.hasError('required')">
              Proyecto es requerido
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Responsabilidades</mat-label>
            <input matInput formControlName="responsibility" placeholder="Descripción de responsabilidades" required>
            <mat-icon matPrefix>description</mat-icon>
            <mat-error *ngIf="assignmentForm.get('responsibility')?.hasError('required')">
              Responsabilidad es requerida
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Fecha Inicio</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="startDate" required>
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
            <mat-icon matPrefix>event</mat-icon>
            <mat-error *ngIf="assignmentForm.get('startDate')?.hasError('required')">
              Fecha inicio es requerida
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fecha Fin</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="endDate">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
            <mat-icon matPrefix>event_available</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Tipo de Liderazgo</mat-label>
            <mat-select formControlName="leadershipType" required>
              <mat-option [value]="true">
                <mat-icon>corporate_fare</mat-icon>
                Integrity
              </mat-option>
              <mat-option [value]="false">
                <mat-icon>business_center</mat-icon>
                Externo
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>leaderboard</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="status" required>
              <mat-option [value]="true">
                <mat-icon>check_circle</mat-icon>
                Activo
              </mat-option>
              <mat-option [value]="false">
                <mat-icon>cancel</mat-icon>
                Inactivo
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>status</mat-icon>
          </mat-form-field>
        </div>

        <button mat-raised-button color="primary" (click)="addAssignment()" [disabled]="!assignmentForm.valid" class="add-button">
          <mat-icon>add</mat-icon>
          Agregar Asignación
        </button>
      </form>
    </div>

    <!-- Lista de asignaciones actuales -->
    <div *ngIf="!loading && assignedProjects.length > 0" class="assignments-section">
      <h3 class="section-title">
        <mat-icon>assignment</mat-icon>
        Proyectos Asignados ({{assignedProjects.length}})
      </h3>

      <div class="assignments-grid">
        <div class="assignment-card" *ngFor="let assignment of assignedProjects; let i = index">
          <div class="assignment-header">
            <div class="project-info">
              <mat-icon class="project-icon">folder</mat-icon>
              <div>
                <div class="project-name">{{assignment.projectName}}</div>
                <div class="project-details">
                  <span class="detail-item">
                    <mat-icon>date_range</mat-icon>
                    {{formatDateDisplay(assignment.startDate)}} - {{formatDateDisplay(assignment.endDate) || 'N/A'}}
                  </span>
                </div>
              </div>
            </div>
            <button mat-icon-button color="warn" (click)="removeAssignment(i)" class="delete-btn" matTooltip="Eliminar asignación">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="assignment-details">
            <div class="detail-row">
              <span class="detail-label">
                <mat-icon>description</mat-icon>
                Responsabilidad:
              </span>
              <span class="detail-value">{{assignment.responsibility || 'Sin especificar'}}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">
                <mat-icon>leaderboard</mat-icon>
                Tipo:
              </span>
              <span class="detail-value" [class.integrity]="assignment.leadershipType" [class.external]="!assignment.leadershipType">
                {{getLeadershipTypeName(assignment.leadershipType)}}
              </span>
            </div>

            <div class="detail-row">
              <span class="detail-label">
                <mat-icon>status</mat-icon>
                Estado:
              </span>
              <span class="detail-value" [class.active]="assignment.status" [class.inactive]="!assignment.status">
                {{getStatusName(assignment.status)}}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!loading && assignedProjects.length === 0" class="no-assignments">
      <mat-icon class="no-data-icon">assignment</mat-icon>
      <p>No hay proyectos asignados</p>
      <span class="hint">Agrega proyectos usando el formulario superior</span>
    </div>

    <div class="saving-spinner" *ngIf="saving">
      <mat-spinner diameter="30"></mat-spinner>
      <p>Guardando asignaciones...</p>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-actions">
  <button mat-button (click)="onClose()" class="cancel-btn">
    <mat-icon>cancel</mat-icon>
    Cancelar
  </button>
  <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="saving || assignedProjects.length === 0" class="save-btn">
    <mat-icon>{{saving ? 'hourglass_empty' : 'save'}}</mat-icon>
    {{saving ? 'Guardando...' : 'Guardar Cambios'}}
  </button>
</mat-dialog-actions>
