<!-- user-create-dialog.component.html -->
<h2 mat-dialog-title>Nuevo Usuario</h2>

<mat-dialog-content>
  <form [formGroup]="userForm" class="user-form">

    <!-- Eliminado el input de búsqueda separado -->
    <!-- <mat-form-field appearance="outline" class="full-width">
      <input matInput
             (input)="onSearchChange($event)"
             placeholder="Buscar empleado...">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field> -->

    <mat-form-field appearance="outline" class="full-width">
      <mat-select formControlName="employeeID" required>
        <!-- Campo de búsqueda integrado en el select -->
        <mat-option>
          <ngx-mat-select-search
            [formControl]="employeeFilterCtrl"
            placeholderLabel="Buscar empleado..."
            noEntriesFoundLabel="No se encontraron empleados">
          </ngx-mat-select-search>
        </mat-option>

        <mat-option
          *ngFor="let employee of filteredEmployees | async"
          [value]="employee.id">
          {{employee.person.firstName}} {{employee.person.lastName}} - {{employee.person.identificationNumber}}
        </mat-option>
      </mat-select>
      <mat-hint *ngIf="loadingEmployees">Buscando empleados...</mat-hint>
      <mat-error *ngIf="userForm.get('employeeID')?.hasError('required')">
        El empleado es obligatorio
      </mat-error>
    </mat-form-field>

    <!-- Campo de Correo Corporativo (solo lectura) -->
    <mat-form-field appearance="outline" class="full-width">
      <input matInput
             formControlName="corporateEmail"
             readonly
             placeholder="Correo Corporativo">
      <mat-icon matSuffix>email</mat-icon>
    </mat-form-field>

    <!-- Nombre de usuario -->
    <mat-form-field appearance="outline" class="full-width">
      <input matInput formControlName="username" placeholder="Nombre de Usuario" required>
      <mat-error *ngIf="userForm.get('username')?.hasError('required')">
        El nombre de usuario es obligatorio
      </mat-error>
    </mat-form-field>

    <!-- Roles -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-select formControlName="rolesID" multiple placeholder="Roles" required>
        <mat-option *ngFor="let role of roles" [value]="role.id">
          {{role.roleName}}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="userForm.get('rolesID')?.hasError('required')">
        Debe seleccionar al menos un rol
      </mat-error>
    </mat-form-field>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="loading">Cancelar</button>
  <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="!userForm.valid || loading">
    <span *ngIf="!loading">Crear</span>
    <span *ngIf="loading">
      <mat-spinner diameter="20" class="spinner-button"></mat-spinner>
      Creando...
    </span>
  </button>
</mat-dialog-actions>
